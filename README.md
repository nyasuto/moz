
# **moz：ミニマルなキーバリューストア（学習用）**

  

moz は、ファイルベース・追記型のキーバリュー型データベースを、最初はLinuxコマンドだけで構築し、その後Go言語でログ構造型データベースへと進化させる学習プロジェクトです。

  

## **🐦 プロジェクトのコンセプト**

  

鳥の「モズ」のように、小さくて賢く、素早くデータを「捕まえて」保存します。最初は単純なログファイルだけの設計からはじまり、徐々に賢く、そして高機能なデータベースへと育てていきます。

  

## **🎯 プロジェクトの目的**

- データベースの内部構造を学ぶための実践的プロジェクト
    
- シェルスクリプトとUnix系ツールで基本を構築 findやcatなどLinuxの基本コマンドでデータのIOや検索を実現する 
- シェルバージョンで数万件のデータを処理するテストコードを書く
- テストコードの性能を計測して、保存しておく
    
- Goによるログ構造データベースに発展
    
- 永続化、コンパクション、インデックス、性能改善などの段階的導入
- 改善のたびに、数万件のテストコードで性能を計測し、進化の歴史を保存する
    
- 全体をファイルベースで保ち、透明性を維持
    

  

## **📁 プロジェクト構成**

### **フェーズ1：シェル版（legacy/）**
```
moz/
├── legacy/
│   ├── put.sh          # キーと値の追加（または更新）
│   ├── get.sh          # キーの値を取得
│   ├── del.sh          # キーの削除
│   ├── list.sh         # 全件の一覧表示
│   ├── filter.sh       # 条件付き一覧表示（例：キーに「foo」を含む）
│   ├── compact.sh      # ログを整理して最新状態にまとめる
│   └── test_performance.sh # 性能測定テスト
└── moz.log         # 追記専用のデータログファイル
```

### **フェーズ2：Go実装**
```
moz/
├── cmd/
│   └── moz/
│       └── main.go     # CLI エントリーポイント
├── internal/
│   └── kvstore/
│       └── kvstore.go  # KVストア実装
├── go.mod              # Go module 定義
├── Makefile            # 統合開発コマンド
└── .gitignore          # Git除外設定
```

## **🧱 フェーズ1：シェルベースのKVストア**

- フォーマット：1行＝key<TAB>value
    
- 操作はすべて追記型（不変性を保持）
    
- 削除は実際には__DELETED__マーカーの追記で表現
    
- compact によって最新状態を再構成
    

  

### **例：**

```
name    Alice
city    Tokyo
name    Bob
```

この場合、name の最新値は Bob

  

## **🔁 フェーズ2：Goによるログ構造型KVストア（実装完了✅）**

### **実装済み機能**
- ✅ **CRUD操作完全実装**: PUT/GET/DELETE/LIST/COMPACT
- ✅ **メモリマップ最適化**: 高速なデータアクセス
- ✅ **スレッドセーフ実装**: sync.RWMutex使用
- ✅ **レガシー互換性**: シェル版とファイル形式完全互換
- ✅ **統合ビルドシステム**: Makefileベースの開発ワークフロー
- ✅ **包括的テスト**: 品質チェック・性能テスト・CI/CD完備

### **アーキテクチャ**
- 現代的なGoプロジェクト構造を採用
- cmd/moz/ に CLI エントリーポイント  
- internal/kvstore/ にKVストア実装
- moz.log をそのままGoで読み込んで処理
- メモリ上に map[string]string を構築（遅延ロード）
- compact() 機能で最新状態を再構成

### **使用方法**

```bash
# 開発環境セットアップ
make dev

# Go版 基本操作
make go-run ARGS="put name Alice"
make go-run ARGS="get name"           # Output: Alice
make go-run ARGS="list"               # 全キー・バリュー表示
make go-run ARGS="del name"           # キー削除
make go-run ARGS="compact"            # ストレージ最適化

# バイナリビルドと直接実行
make go-build
./bin/moz put city Tokyo
./bin/moz get city                    # Output: Tokyo

# レガシーシェル版も利用可能
./legacy/put.sh name Bob
./legacy/get.sh name                  # Output: Bob

# 品質チェック
make quality                          # 基本品質チェック
make quality-full                     # セキュリティ含む包括的チェック
```
    

  

## **🚀 開発ロードマップ**

### **現在のステータス**
- ✅ **フェーズ1完了**: シェルベースKVストア
- ✅ **フェーズ2完了**: Go実装・CRUD操作・メモリ最適化

### **次期開発予定**

|**フェーズ**|**機能**|**ステータス**|**内容**|
|---|---|---|---|
|**2.1**|**自動コンパクション**|🔄 予定|ファイルサイズ閾値での自動最適化|
|**2.2**|**性能ベンチマーク**|🔄 予定|Go版とシェル版の詳細比較測定|
|**3**|**インデックス対応**|📋 計画中|高速な検索を実現|
|**4**|**クエリ言語導入**|📋 計画中|条件付き検索の高度化|
|**5**|**バックグラウンドコンパクション**|📋 計画中|LSMツリーのような構造へ|
|**6**|**スナップショット対応**|📋 計画中|バックアップ・復元機能|
|**7**|**並列処理とロック**|📋 計画中|複数プロセスの安全な同時操作対応|
|**8**|**REST API対応**|📋 計画中|外部との通信・Web連携|

### **開発状況追跡**
GitHub Issues で進捗管理中。[プロジェクトボード](https://github.com/nyasuto/moz/issues)で最新状況を確認できます。

## **🤖 AIエージェント向け文脈説明**

  

このリポジトリはAIエージェントが理解しやすい構造を意図して設計されています。

- **入口**：README.md から読み始めること
    
- **段階に応じた支援**：現在のフェーズに合わせた提案・実装のみ行うこと
    
- **進化段階を尊重**：シンプルな段階から徐々に進化することを前提とする
    

  

## **📝 ライセンス**

  

MITライセンス。学習目的のため、フォークや提案、改変も歓迎です。

---

必要であれば、次に put.sh などの各スクリプトを一つずつ生成していくこともできます。ご希望があればお知らせください。