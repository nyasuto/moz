# **moz：高性能キーバリューストア（学習用プロジェクト）**

**シェルスクリプトからGo言語まで、段階的に学ぶデータベース実装**

---

moz は、ファイルベース・追記型のキーバリュー型データベースを、最初はLinuxコマンドだけで構築し、その後Go言語でログ構造型データベースへと進化させる学習プロジェクトです。

## **🐦 プロジェクトのコンセプト**

鳥の「モズ」のように、小さくて賢く、素早くデータを「捕まえて」保存します。最初は単純なログファイルだけの設計からはじまり、徐々に賢く、そして高機能なデータベースへと育てていきます。

## **🎯 プロジェクトの目的**

- **データベース内部構造の実践的学習**: 基本から高度な機能まで段階的に理解
- **シェルとGoの比較学習**: 同一機能を異なる実装で比較・分析
- **性能測定による学習**: 定量的な改善効果を可視化
- **実用的な開発ワークフロー習得**: CI/CD、品質管理、テスト手法

## **📊 現在の実装状況**

### **✅ 完了済み機能**

| フェーズ | 機能 | 実装状況 | 説明 |
|---------|------|----------|------|
| **1** | **シェル版基本実装** | ✅ 完了 | PUT/GET/DELETE/LIST/COMPACT/FILTER |
| **2.0** | **Go版基本実装** | ✅ 完了 | CRUD操作、メモリ最適化、スレッドセーフ |
| **2.1** | **自動コンパクション** | ✅ 完了 | ファイルサイズ・操作数・削除率による自動最適化 |
| **2.2** | **シェル-Go互換性** | ✅ 完了 | 完全互換性テスト、ファイル共有対応 |
| **2.3** | **性能ベンチマーク** | ✅ 完了 | Go vs Shell詳細比較、メモリ測定 |

## **📁 プロジェクト構成**

```
moz/
├── legacy/                    # Phase 1: シェル版実装
│   ├── put.sh                # キーと値の追加・更新
│   ├── get.sh                # キーの値を取得
│   ├── del.sh                # キーの削除
│   ├── list.sh               # 全件の一覧表示
│   ├── filter.sh             # 条件付き一覧表示
│   ├── compact.sh            # ログ整理・最適化
│   ├── test_performance.sh   # 性能測定テスト
│   └── analyze_performance.sh # 性能分析
│
├── cmd/moz/main.go           # Go版 CLI エントリーポイント
├── internal/kvstore/         # Go版 KVストア実装
│   ├── kvstore.go           # メイン実装（自動コンパクション含む）
│   ├── reader.go            # ログファイル読み込み
│   ├── validation.go        # データ検証
│   └── *_test.go           # 包括的テストスイート
│
├── scripts/                  # 性能測定・比較ツール
│   ├── compatibility_test.sh # シェル-Go互換性テスト
│   ├── shell_benchmark.sh   # シェル版ベンチマーク
│   ├── simple_benchmark.sh  # 簡易比較ツール
│   └── performance_comparison.sh # 包括的性能比較
│
├── benchmark_results/        # 性能測定結果（JSON形式）
├── .github/workflows/ci.yml  # CI/CD パイプライン
├── Makefile                  # 統合開発コマンド
├── go.mod                    # Go module 定義
└── moz.log                  # 共有データファイル
```

## **🚀 使用方法**

### **開発環境セットアップ**
```bash
make help                     # 利用可能コマンド一覧
make dev                      # 開発環境セットアップ
```

### **Go版（推奨）**
```bash
# ビルド
make go-build

# 基本操作
./bin/moz put name "Alice"    # データ追加
./bin/moz get name            # データ取得 → Alice
./bin/moz list                # 全データ表示
./bin/moz del name            # データ削除
./bin/moz compact             # 手動コンパクション
./bin/moz stats               # 統計情報表示

# Makefileコマンド
make go-run ARGS="put city Tokyo"
make go-run ARGS="get city"
```

### **シェル版（レガシー）**
```bash
# 基本操作
./legacy/put.sh name "Bob"
./legacy/get.sh name          # Output: Bob
./legacy/list.sh
./legacy/del.sh name
./legacy/compact.sh
```

### **互換性テスト**
```bash
# シェル版とGo版の完全互換性テスト
scripts/compatibility_test.sh

# 出力例:
# 🎉 All compatibility tests passed!
# Shell and Go implementations are fully compatible.
```

### **性能測定・比較**
```bash
# 個別ベンチマーク
make bench-go                 # Go実装ベンチマーク
make bench-shell              # シェル実装ベンチマーク

# 性能比較
make bench-compare            # 包括的比較（推奨）
make bench-quick              # クイック比較

# 実測例（Apple M4 Pro）:
# Go PUT: 44,723 ns/op
# Shell PUT: 1,674,640 ns/op
# → Goが約37倍高速
```

### **品質管理**
```bash
make quality                  # 基本品質チェック
make quality-full             # セキュリティ含む包括的チェック
make pr-ready                 # PR提出前チェック
```

## **🔧 主要機能詳細**

### **自動コンパクション（Issue #16 ✅）**
- **ファイルサイズ閾値**: 1MB超過で自動実行
- **操作数閾値**: 1000操作で自動実行  
- **削除率閾値**: 削除済みエントリが50%超過で自動実行
- **非同期実行**: デッドロック回避、パフォーマンス最適化

### **シェル-Go完全互換性（Issue #17 ✅）**
- **ファイル共有**: 両実装が`./moz.log`を共有
- **フォーマット互換**: TAB区切り形式で完全互換
- **相互運用**: シェル→Go、Go→シェル自由切り替え
- **包括的テスト**: 12種類の互換性テスト自動実行

### **性能ベンチマークシステム（Issue #18 ✅）**
- **Go標準ベンチマーク**: memory allocation、並行性能測定
- **シェル版ベンチマーク**: 同条件での公平な比較
- **JSON結果出力**: 履歴追跡、継続的性能監視
- **大容量データ対応**: 1K-100K エントリでの性能特性分析

## **📈 性能比較結果**

### **実測データ（Apple M4 Pro、1000操作）**

| 操作 | Go実装 | Shell実装 | Go優位性 |
|------|--------|-----------|----------|
| PUT | 44,723 ns/op | 1,674,640 ns/op | **37x 高速** |
| GET | 12,580 ns/op | 892,340 ns/op | **71x 高速** |
| LIST | 156,200 ns/op | 2,340,000 ns/op | **15x 高速** |

### **メモリ効率性**
- **Go実装**: リアルタイムメモリ使用量追跡
- **キャッシュ効果**: 2回目以降のアクセスで大幅高速化
- **並行処理**: マルチコア環境でさらなる性能向上

## **🔄 開発ワークフロー**

### **CI/CDパイプライン**
```bash
# GitHub Actions で自動実行
- 品質チェック（lint, format, type-check）  
- セキュリティスキャン（gosec, govulncheck）
- 統合テスト（CRUD操作、性能テスト）
- シェル-Go互換性テスト
- ブランチ保護・命名規則チェック
```

### **ブランチ戦略**
```bash
# ブランチ命名規則（CLAUDE.md準拠）
feat/issue-X-feature-name     # 新機能
fix/issue-X-description       # バグ修正
test/X-description           # テスト追加
docs/X-description           # ドキュメント
refactor/X-description       # リファクタリング
```

### **品質管理**
- **Pre-commit hooks**: 自動品質チェック
- **Conventional Commits**: 標準化されたコミットメッセージ
- **Issue tracking**: 日本語での詳細Issue管理
- **PR review**: 包括的コードレビュープロセス

## **🚀 今後の開発ロードマップ**

### **Phase 3: 高度機能（計画中）**

| フェーズ | 機能 | 優先度 | 説明 |
|---------|------|--------|------|
| **3.1** | **インデックス対応** | 高 | B-Tree, Hash Indexによる高速検索 |
| **3.2** | **クエリ言語** | 中 | 条件付き検索の高度化 |
| **3.3** | **LSMツリー実装** | 中 | Write Amplificationの最適化 |
| **3.4** | **マルチバージョン対応** | 低 | MVCC（Multi-Version Concurrency Control） |

### **Phase 4: エンタープライズ機能（構想中）**

| フェーズ | 機能 | 説明 |
|---------|------|------|
| **4.1** | **分散対応** | レプリケーション、シャーディング |
| **4.2** | **REST API** | HTTP/JSONによるリモートアクセス |
| **4.3** | **監視・メトリクス** | OpenTelemetry対応 |
| **4.4** | **バックアップ・復元** | Point-in-time recovery |

## **🎓 学習効果**

このプロジェクトを通じて習得できる技術:

### **データベース技術**
- ログ構造マージツリー（LSM-Tree）の理解
- 追記型データベースの設計原理
- コンパクション・ガベージコレクション
- インデックス設計とアクセスパターン最適化

### **システムプログラミング**
- Go言語での並行プログラミング
- メモリ管理とパフォーマンス最適化
- ファイルI/O、システムコール
- クロスプラットフォーム対応

### **ソフトウェア開発プロセス**
- テスト駆動開発（TDD）
- 継続的インテグレーション（CI/CD）
- 性能ベンチマーキング手法
- コードレビューとチーム開発

### **運用・監視**
- 性能プロファイリング
- メトリクス収集・分析
- 品質管理・自動化
- デバッグ・トラブルシューティング

## **🤖 AI開発支援向け設計**

このプロジェクトはAI開発支援ツールとの協調を前提に設計:

- **段階的進化**: 複雑さを段階的に導入、理解しやすい構造
- **包括的ドキュメント**: `CLAUDE.md`での開発ルール明文化
- **自動化**: Makefile、CI/CDによる一貫した開発体験
- **テスタビリティ**: 包括的テストによる安全な変更
- **トレーサビリティ**: Issue tracking、履歴追跡

## **📝 貢献・フィードバック**

### **開発状況**
- **GitHub Issues**: [プロジェクトボード](https://github.com/nyasuto/moz/issues)
- **Pull Requests**: コードレビュー歓迎
- **Discussions**: アイデア・提案の議論

### **ライセンス**
MITライセンス。学習目的のため、フォーク・改変・提案すべて歓迎です。

---

**学習の旅はここから始まります。シンプルなログファイルから、本格的なデータベースシステムまで、一緒に構築していきましょう！**