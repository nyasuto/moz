name: ğŸ¯ Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (ä¾‹: v1.0.0)'
        required: true
        type: string

env:
  RELEASE_VERSION: ${{ github.event.inputs.version || github.ref_name }}

jobs:
  validate-release:
    name: ğŸ” ãƒªãƒªãƒ¼ã‚¹æ¤œè¨¼
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v5
        
      - name: ğŸ“¦ é–‹ç™ºãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck jq bc
          
      - name: ğŸ”§ ä¾å­˜é–¢ä¿‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: make install
        
      - name: ğŸ¯ ãƒ•ãƒ«å“è³ªãƒã‚§ãƒƒã‚¯
        run: make pr-ready
        
      - name: ğŸ“Š å¤§è¦æ¨¡æ€§èƒ½ãƒ†ã‚¹ãƒˆ
        run: ./legacy/test_performance.sh 5000
        
      - name: ğŸ“ˆ æ€§èƒ½åŸºæº–ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ“ˆ æ€§èƒ½åŸºæº–ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          latest_result=$(ls -t benchmark_results/performance_*.json | head -1)
          
          put_speed=$(jq -r '.test_run.results[] | select(.operation == "put") | .ops_per_sec' "$latest_result")
          get_speed=$(jq -r '.test_run.results[] | select(.operation == "get") | .ops_per_sec' "$latest_result")
          
          echo "PUTé€Ÿåº¦: ${put_speed} ops/sec"
          echo "GETé€Ÿåº¦: ${get_speed} ops/sec"
          
          # æ€§èƒ½åŸºæº–ï¼ˆæœ€ä½é™ã®è¦æ±‚ï¼‰
          if (( $(echo "$put_speed < 100" | bc -l) )); then
            echo "âŒ PUTæ“ä½œã®æ€§èƒ½ãŒåŸºæº–ä»¥ä¸‹ã§ã™ (æœ€ä½100 ops/sec)"
            exit 1
          fi
          
          if (( $(echo "$get_speed < 50" | bc -l) )); then
            echo "âŒ GETæ“ä½œã®æ€§èƒ½ãŒåŸºæº–ä»¥ä¸‹ã§ã™ (æœ€ä½50 ops/sec)"
            exit 1
          fi
          
          echo "âœ… æ€§èƒ½åŸºæº–ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ"

  create-release:
    name: ğŸ ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
    runs-on: ubuntu-latest
    needs: validate-release
    
    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          
      - name: ğŸ“¦ é–‹ç™ºãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc
          
      - name: ğŸ”§ ãƒªãƒªãƒ¼ã‚¹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸æº–å‚™
        run: |
          mkdir -p release-package
          
          # ãƒ¬ã‚¬ã‚·ãƒ¼ã‚³ãƒ¼ãƒ‰
          cp -r legacy release-package/
          
          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
          cp Makefile release-package/
          cp README.md release-package/
          cp CLAUDE.md release-package/
          cp .gitignore release-package/
          
          # æœ€æ–°ã®æ€§èƒ½çµæœã‚’å«ã‚ã‚‹
          if [ -d "benchmark_results" ]; then
            cp -r benchmark_results release-package/
          fi
          
      - name: ğŸ“Š ãƒªãƒªãƒ¼ã‚¹æ€§èƒ½ãƒ†ã‚¹ãƒˆ
        run: |
          cd release-package
          make install
          ./legacy/test_performance.sh 1000
          
      - name: ğŸ“‹ ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆ
        id: release_notes
        run: |
          echo "## ğŸš€ Moz KVã‚¹ãƒˆã‚¢ ${RELEASE_VERSION}" > release_notes.md
          echo "" >> release_notes.md
          echo "### ğŸ“¦ ã“ã®ãƒªãƒªãƒ¼ã‚¹ã«å«ã¾ã‚Œã‚‹ã‚‚ã®" >> release_notes.md
          echo "" >> release_notes.md
          echo "#### ğŸš Phase 1: ã‚·ã‚§ãƒ«ãƒ™ãƒ¼ã‚¹KVã‚¹ãƒˆã‚¢ (Legacy)" >> release_notes.md
          echo "- âœ… åŸºæœ¬çš„ãªKVã‚¹ãƒˆã‚¢æ“ä½œ (PUT/GET/DELETE/LIST/FILTER)" >> release_notes.md
          echo "- âœ… è¿½è¨˜å‹ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«è¨­è¨ˆ" >> release_notes.md
          echo "- âœ… ã‚³ãƒ³ãƒ‘ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½" >> release_notes.md
          echo "- âœ… åŒ…æ‹¬çš„ãªæ€§èƒ½æ¸¬å®šã‚·ã‚¹ãƒ†ãƒ " >> release_notes.md
          echo "- âœ… è‡ªå‹•å“è³ªãƒã‚§ãƒƒã‚¯ (shellcheckå¯¾å¿œ)" >> release_notes.md
          echo "" >> release_notes.md
          echo "#### ğŸ”§ é–‹ç™ºãƒ„ãƒ¼ãƒ«" >> release_notes.md
          echo "- âœ… Makefileçµ±åˆé–‹ç™ºç’°å¢ƒ" >> release_notes.md
          echo "- âœ… Git Hooks (ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ»å“è³ªãƒã‚§ãƒƒã‚¯)" >> release_notes.md
          echo "- âœ… CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³" >> release_notes.md
          echo "- âœ… æ—¥æœ¬èªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå®Œå‚™" >> release_notes.md
          echo "" >> release_notes.md
          
          # æœ€æ–°ã®æ€§èƒ½çµæœã‚’è¿½åŠ 
          if [ -f "release-package/benchmark_results/"*.json ]; then
            latest_result=$(ls -t release-package/benchmark_results/performance_*.json | head -1)
            echo "#### ğŸ“Š æ€§èƒ½ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ (1000ä»¶)" >> release_notes.md
            echo "" >> release_notes.md
            put_speed=$(jq -r '.test_run.results[] | select(.operation == "put") | .ops_per_sec' "$latest_result")
            get_speed=$(jq -r '.test_run.results[] | select(.operation == "get") | .ops_per_sec' "$latest_result")
            list_speed=$(jq -r '.test_run.results[] | select(.operation == "list") | .ops_per_sec' "$latest_result")
            compact_speed=$(jq -r '.test_run.results[] | select(.operation == "compact") | .ops_per_sec' "$latest_result")
            
            echo "- **PUTæ“ä½œ**: ${put_speed} ops/sec" >> release_notes.md
            echo "- **GETæ“ä½œ**: ${get_speed} ops/sec" >> release_notes.md
            echo "- **LISTæ“ä½œ**: ${list_speed} ops/sec" >> release_notes.md
            echo "- **COMPACTæ“ä½œ**: ${compact_speed} ops/sec" >> release_notes.md
            echo "" >> release_notes.md
          fi
          
          echo "### ğŸš€ ä½¿ç”¨æ–¹æ³•" >> release_notes.md
          echo "" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "# åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—" >> release_notes.md
          echo "make dev" >> release_notes.md
          echo "" >> release_notes.md
          echo "# åŸºæœ¬æ“ä½œ" >> release_notes.md
          echo "./legacy/put.sh name Alice" >> release_notes.md
          echo "./legacy/get.sh name" >> release_notes.md
          echo "./legacy/list.sh" >> release_notes.md
          echo "" >> release_notes.md
          echo "# æ€§èƒ½æ¸¬å®š" >> release_notes.md
          echo "./legacy/test_performance.sh 1000" >> release_notes.md
          echo "./legacy/analyze_performance.sh" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ğŸ“‹ æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚º" >> release_notes.md
          echo "" >> release_notes.md
          echo "- ğŸš§ **Phase 2**: Goè¨€èªã«ã‚ˆã‚‹ãƒ­ã‚°æ§‹é€ å‹KVã‚¹ãƒˆã‚¢å®Ÿè£…äºˆå®š" >> release_notes.md
          echo "- ğŸš§ **Phase 3**: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å¯¾å¿œãƒ»é«˜åº¦æ©Ÿèƒ½" >> release_notes.md
          echo "" >> release_notes.md
          echo "è©³ç´°ã¯ [README.md](README.md) ã¨ [CLAUDE.md](CLAUDE.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚" >> release_notes.md
          
          # GitHubã®step outputã«è¨­å®š
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: ğŸ—œï¸ ãƒªãƒªãƒ¼ã‚¹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åœ§ç¸®
        run: |
          tar -czf moz-kvstore-${RELEASE_VERSION}.tar.gz -C release-package .
          zip -r moz-kvstore-${RELEASE_VERSION}.zip release-package/
          
          # ãƒã‚§ãƒƒã‚¯ã‚µãƒ ç”Ÿæˆ
          sha256sum moz-kvstore-${RELEASE_VERSION}.tar.gz > checksums.txt
          sha256sum moz-kvstore-${RELEASE_VERSION}.zip >> checksums.txt
          
      - name: ğŸ GitHubãƒªãƒªãƒ¼ã‚¹ä½œæˆ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_VERSION }}
          name: ğŸš€ Moz KVã‚¹ãƒˆã‚¢ ${{ env.RELEASE_VERSION }}
          body: ${{ steps.release_notes.outputs.notes }}
          files: |
            moz-kvstore-${{ env.RELEASE_VERSION }}.tar.gz
            moz-kvstore-${{ env.RELEASE_VERSION }}.zip
            checksums.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ“¢ ãƒªãƒªãƒ¼ã‚¹å®Œäº†é€šçŸ¥
        run: |
          echo "ğŸ‰ ãƒªãƒªãƒ¼ã‚¹ ${{ env.RELEASE_VERSION }} ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼"
          echo "ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ãªã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ:"
          echo "  - moz-kvstore-${{ env.RELEASE_VERSION }}.tar.gz"
          echo "  - moz-kvstore-${{ env.RELEASE_VERSION }}.zip"
          echo "  - checksums.txt (ãƒã‚§ãƒƒã‚¯ã‚µãƒ æ¤œè¨¼ç”¨)"