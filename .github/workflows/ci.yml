name: ğŸš€ Moz KVã‚¹ãƒˆã‚¢ CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  quality-checks:
    name: ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ¹ Goè¨€èªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache: true
          cache-dependency-path: |
            go.sum
            go.mod
          
      - name: ğŸ“¦ ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          
      - name: ğŸ”§ ä¾å­˜é–¢ä¿‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: make install
        
      - name: ğŸ” golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: latest
          args: --timeout=5m
          
      - name: ğŸ” ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°
        run: |
          echo "ğŸ” ãƒ¬ã‚¬ã‚·ãƒ¼ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒªãƒ³ãƒ†ã‚£ãƒ³ã‚°ä¸­..."
          if command -v shellcheck >/dev/null 2>&1; then \
            shellcheck legacy/*.sh; \
          else \
            echo "âš ï¸  shellcheck ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"; \
            echo "   brew install shellcheck ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"; \
          fi
        
      - name: âœ¨ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
        run: |
          make format
          if ! git diff --exit-code; then
            echo "âŒ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒé©ç”¨ã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "ğŸ’¡ ãƒ­ãƒ¼ã‚«ãƒ«ã§ 'make format' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
            exit 1
          fi
          
      - name: ğŸ” æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        run: make type-check
        
      - name: ğŸ›¡ï¸ è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
        uses: golang/govulncheck-action@v1
        with:
          go-version-input: 'stable'
          go-package: './...'

  performance-tests:
    name: ğŸ“Š æ€§èƒ½ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    needs: quality-checks
    
    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ¹ Goè¨€èªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache: true
          cache-dependency-path: |
            go.sum
            go.mod
          
      - name: ğŸ“¦ ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc
            
      - name: ğŸ”§ ä¾å­˜é–¢ä¿‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: make install
        
      - name: ğŸ§ª å°è¦æ¨¡æ€§èƒ½ãƒ†ã‚¹ãƒˆ (100ä»¶)
        run: ./legacy/test_performance.sh 100
        
      - name: ğŸ“Š æ€§èƒ½åˆ†æ
        run: ./legacy/analyze_performance.sh
        
      - name: ğŸ—‚ï¸ æ€§èƒ½çµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: benchmark_results/
          retention-days: 30

  integration-tests:
    name: ğŸ”„ çµ±åˆãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    needs: quality-checks
    
    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ¹ Goè¨€èªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache: true
          cache-dependency-path: |
            go.sum
            go.mod
            
      - name: ğŸ”§ ä¾å­˜é–¢ä¿‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        run: make install
        
      - name: ğŸ§ª åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        run: |
          echo "ğŸ”§ åŸºæœ¬çš„ãªKVã‚¹ãƒˆã‚¢æ“ä½œãƒ†ã‚¹ãƒˆ"
          cd legacy
          
          # ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
          rm -f ../moz.log
          
          # åŸºæœ¬æ“ä½œãƒ†ã‚¹ãƒˆ
          ./put.sh name Alice
          ./put.sh city Tokyo
          ./put.sh name Bob  # æ›´æ–°
          
          # å–å¾—ãƒ†ã‚¹ãƒˆ
          result=$(./get.sh name)
          if [ "$result" != "Bob" ]; then
            echo "âŒ GET ãƒ†ã‚¹ãƒˆå¤±æ•—: æœŸå¾…å€¤Bob, å®Ÿéš›å€¤$result"
            exit 1
          fi
          
          # ä¸€è¦§ãƒ†ã‚¹ãƒˆ
          count=$(./list.sh | wc -l)
          if [ "$count" -ne 2 ]; then
            echo "âŒ LIST ãƒ†ã‚¹ãƒˆå¤±æ•—: æœŸå¾…å€¤2è¡Œ, å®Ÿéš›å€¤${count}è¡Œ"
            exit 1
          fi
          
          # å‰Šé™¤ãƒ†ã‚¹ãƒˆ
          ./del.sh name
          if ./get.sh name 2>/dev/null; then
            echo "âŒ DELETE ãƒ†ã‚¹ãƒˆå¤±æ•—: å‰Šé™¤ã•ã‚ŒãŸã‚­ãƒ¼ãŒå–å¾—ã§ãã¾ã—ãŸ"
            exit 1
          fi
          
          # ã‚³ãƒ³ãƒ‘ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
          ./compact.sh
          final_count=$(./list.sh | wc -l)
          if [ "$final_count" -ne 1 ]; then
            echo "âŒ COMPACT ãƒ†ã‚¹ãƒˆå¤±æ•—: æœŸå¾…å€¤1è¡Œ, å®Ÿéš›å€¤${final_count}è¡Œ"
            exit 1
          fi
          
          echo "âœ… å…¨ã¦ã®çµ±åˆãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ"

  makefile-targets:
    name: ğŸ”¨ Makefileã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    needs: quality-checks
    
    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ¹ Goè¨€èªã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-go@v5
        with:
          go-version: 'stable'
          cache: true
          cache-dependency-path: |
            go.sum
            go.mod
          
      - name: ğŸ“¦ ã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck jq bc
          
      - name: ğŸ”§ make help
        run: make help
        
      - name: ğŸš€ make dev
        run: make dev
        
      - name: ğŸ§¹ make clean
        run: make clean
        
      - name: â„¹ï¸ make env-info
        run: make env-info
        
      - name: ğŸ“‹ make pr-ready
        run: make pr-ready

  security-scan:
    name: ğŸ”’ è¿½åŠ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ” ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³
        run: |
          echo "ğŸ” ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          if grep -r -i -E "(password|secret|token|key|api)" --include="*.sh" --include="*.md" --exclude-dir=".git" . | grep -v "# " | grep -v "echo"; then
            echo "âš ï¸ æ½œåœ¨çš„ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆä¸Šè¨˜å‚ç…§ï¼‰"
            echo "ğŸ” å†…å®¹ã‚’ç¢ºèªã—ã€å®Ÿéš›ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã§ãªã„ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          else
            echo "âœ… ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
          fi
          
      - name: ğŸ›¡ï¸ ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ›¡ï¸ å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          find . -name "*.sh" -type f | while read -r file; do
            if [ -x "$file" ]; then
              echo "âœ… $file (å®Ÿè¡Œå¯èƒ½)"
            else
              echo "âš ï¸ $file (å®Ÿè¡Œæ¨©é™ãªã—)"
            fi
          done

  branch-protection-test:
    name: ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ” ãƒ–ãƒ©ãƒ³ãƒåãƒã‚§ãƒƒã‚¯
        run: |
          branch_name="${{ github.head_ref }}"
          echo "ãƒã‚§ãƒƒã‚¯å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ: $branch_name"
          
          if ! echo "$branch_name" | grep -E "^(feat|fix|hotfix|test|docs|ci|cicd|refactor|perf|security|deps|dependabot)/.*"; then
            echo "âŒ ãƒ–ãƒ©ãƒ³ãƒåãŒCLAUDE.mdã®å‘½åè¦å‰‡ã«å¾“ã£ã¦ã„ã¾ã›ã‚“"
            echo "ğŸ“‹ æ¨å¥¨å½¢å¼:"
            echo "   feat/issue-X-feature-name"
            echo "   fix/issue-X-description"
            echo "   ci/X-description"
            echo "   docs/X-description"
            echo "   test/X-description"
            echo "   refactor/X-description"
            echo "   dependabot/* (automated dependency updates)"
            exit 1
          fi
          
          echo "âœ… ãƒ–ãƒ©ãƒ³ãƒåãŒå‘½åè¦å‰‡ã«å¾“ã£ã¦ã„ã¾ã™"
          
      - name: ğŸ“ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ“ æœ€æ–°ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          commit_message=$(git log -1 --pretty=format:"%s")
          echo "ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: $commit_message"
          
          if ! echo "$commit_message" | grep -E "^(feat|fix|docs|style|refactor|test|chore|ci):"; then
            echo "âš ï¸ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒConventional Commitså½¢å¼ã«å¾“ã£ã¦ã„ã¾ã›ã‚“"
            echo "ğŸ“‹ æ¨å¥¨å½¢å¼: type: description"
            echo "ä¾‹: feat: æ–°æ©Ÿèƒ½ã‚’è¿½åŠ "
          else
            echo "âœ… ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¦ç´„ã«å¾“ã£ã¦ã„ã¾ã™"
          fi

  results-summary:
    name: ğŸ“Š CIçµæœã‚µãƒãƒªãƒ¼
    runs-on: ubuntu-latest
    needs: [quality-checks, performance-tests, integration-tests, makefile-targets, security-scan]
    if: always()
    
    steps:
      - name: ğŸ“Š çµæœã‚µãƒãƒªãƒ¼
        run: |
          echo "## ğŸš€ Moz KVã‚¹ãƒˆã‚¢ CI/CD çµæœã‚µãƒãƒªãƒ¼"
          echo ""
          echo "| ãƒã‚§ãƒƒã‚¯é …ç›® | çµæœ |"
          echo "|-------------|------|"
          echo "| ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯ | ${{ needs.quality-checks.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |"
          echo "| ğŸ“Š æ€§èƒ½ãƒ†ã‚¹ãƒˆ | ${{ needs.performance-tests.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |"
          echo "| ğŸ”„ çµ±åˆãƒ†ã‚¹ãƒˆ | ${{ needs.integration-tests.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |"
          echo "| ğŸ”¨ Makefileãƒ†ã‚¹ãƒˆ | ${{ needs.makefile-targets.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |"
          echo "| ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ | ${{ needs.security-scan.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }} |"
          echo ""
          
          if [[ "${{ needs.quality-checks.result }}" == "success" && 
                "${{ needs.performance-tests.result }}" == "success" && 
                "${{ needs.integration-tests.result }}" == "success" && 
                "${{ needs.makefile-targets.result }}" == "success" && 
                "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "ğŸ‰ å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸï¼"
            exit 0
          else
            echo "âŒ ä¸€éƒ¨ã®ãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ä¸Šè¨˜ã®ã‚¸ãƒ§ãƒ–ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            exit 1
          fi